{% extends 'base.html' %}

{% block content %}
<h1>Vrste Tekmovanj</h1>
<p>Izberite tekmovanje za prikaz rekordov:</p>

<div class="tree">
    <ul>
        {% for comp_id, comp_data in tree.items() %}
            <li>
                <span class="caret">{{ comp_data.obj.name }}</span>
                <ul class="nested">
                    {% for style_id, style_data in comp_data.styles.items() %}
                        <li>
                            <span class="caret">{{ style_data.obj.name }}</span>
                            <ul class="nested">
                                {% for gender_id, gender_data in style_data.genders.items() %}
                                    <li>
                                        <span class="caret">{{ gender_data.obj.name }}</span>
                                        <ul class="nested">
                                            {% for cat_id, cat_data in gender_data.categories.items() %}
                                                <li>
                                                    <span class="caret">{{ cat_data.obj.name }}</span>
                                                    <ul class="nested">
                                                        {% for subcat_id, subcat in cat_data.subcategories.items() %}
                                                            <li>
                                                                <span>{{ subcat.name }}</span>
                                                                {% if subcat.record_types|length > 0 %}
                                                                    <button class="btn btn-info btn-sm"
                                                                        onclick="showRecordTypes({{ subcat.id }})">
                                                                        Prikaži Record Types
                                                                    </button>
                                                                {% endif %}
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>
</div>

<div class="table-container" id="record-types-container">
    <h3>Record Types</h3>
    <table id="record-types-table" class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ime</th>
                <th>Število puščic</th>
                <th>Velikost lice</th>
                <th>Aktiven</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5">Izberite subkategorijo za prikaz podatkov.</td></tr>
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function showRecordTypes(subcategoryId){
    $('#record-types-container').show();
    $.getJSON('/get_record_types/' + subcategoryId, function(data){
        let tableContent = '';
        if(data.length > 0){
            data.forEach(function(r){
                tableContent += `<tr>
                    <td>${r.id}</td>
                    <td>${r.name}</td>
                    <td>${r.arrow_count || ''}</td>
                    <td>${r.face || ''}</td>
                    <td>${r.is_active ? 'Da' : 'Ne'}</td>
                </tr>`;
            });
        } else {
            tableContent = '<tr><td colspan="5">Ni podatkov</td></tr>';
        }
        $('#record-types-table tbody').html(tableContent);
    });
}

// Drevo toggle
var toggler = document.getElementsByClassName("caret");
for (var i=0; i<toggler.length; i++){
    toggler[i].addEventListener("click", function(){
        var nested = this.parentElement.querySelector(".nested");
        if(nested) nested.classList.toggle("active");
        this.classList.toggle("caret-down");
    });
}
</script>

<style>
.tree { width: 45%; float: left; padding: 20px; }
.tree ul { list-style-type: none; padding-left: 20px; }
.tree li { cursor: pointer; user-select: none; margin-bottom: 5px; }
.caret { cursor: pointer; user-select: none; }
.caret::before { content: "▶ "; }
.caret-down::before { content: "▼ "; }
.nested { display: none; }
.nested.active { display: block; }

.table-container {
    width: 50%;
    padding: 20px;
    display: none;
    float: right;
    max-height: 500px;
    overflow-y: auto;
}
.table-container table { width: 100%; border-collapse: collapse; }
.table-container th, .table-container td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.table-container th { background-color: #f4f4f4; }
</style>
{% endblock %}
