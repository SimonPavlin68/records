{% extends 'base.html' %}

{% block content %}
<h1>Rekordi</h1>
<hr>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div>
    <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#newRecordModal">
      New
    </button>
  </div>

  <div>
    <a href="{{ url_for('rekordi') }}" class="btn btn-sm btn-outline-secondary">
      Reset filtrov
    </a>
  </div>
</div>

<form method="get">
<table class="table table-striped table-hover table-sm">
    <thead>
        <tr>
            <th>#</th>
            <th>Ime in priimek</th>
            <th>Klub</th>
            <th class="col-result">Rezultat</th>
            <th>Datum</th>
            <th>Kraj</th>
            <th>Disciplina</th>
            <th>Podtip</th>
            <th>Puščice</th>
            <th>Stil</th>
            <th>Spol</th>
            <th>Kategorija</th>
            <th>Podkategorija</th>
            <th>Akcija</th>
        </tr>
    <tr>
  <th></th> <!-- # -->

  <th>
    <input name="competitor" class="form-control form-control-sm"
           value="{{ request.args.get('competitor','') }}">
  </th>

  <th>
    <input name="club" class="form-control form-control-sm"
           value="{{ request.args.get('club','') }}">
  </th>

 <th class="col-result">
  <input name="result"
         class="form-control form-control-sm"
         placeholder="≥"
         value="{{ request.args.get('result','') }}">
</th>

  <th>
    <input type="date" name="date_from"
           class="form-control form-control-sm"
           value="{{ request.args.get('date_from','') }}">
  </th>

  <th>
    <input name="location" class="form-control form-control-sm"
           value="{{ request.args.get('location','') }}">
  </th>

  <th>
    <select name="competition_type" class="form-control form-control-sm">
      <option value="">Vse</option>
      {% for c in competition_types %}
        <option value="{{ c.id }}"
          {% if request.args.get('competition_type') == c.id|string %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>
  </th>

  <th>
    <select name="competition_subtype" class="form-control form-control-sm">
      <option value="">Vsi</option>
      {% for s in competition_subtypes %}
        <option value="{{ s.id }}"
          {% if request.args.get('competition_subtype') == s.id|string %}selected{% endif %}>{{ s.name }}
        </option>
      {% endfor %}
    </select>
  </th>

      <th></th>
  <th>
    <select name="style" class="form-control form-control-sm">
      <option value="">Vsi</option>
      {% for s in styles %}
        <option value="{{ s.id }}"
          {% if request.args.get('style') == s.id|string %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </th>

  <th>
    <select name="gender" class="form-control form-control-sm">
      <option value="">Vsi</option>
      {% for g in genders %}
        <option value="{{ g.id }}"
          {% if request.args.get('gender') == g.id|string %}selected{% endif %}>
          {{ g.name }}
        </option>
      {% endfor %}
    </select>
  </th>

  <th>
    <select name="category" class="form-control form-control-sm">
      <option value="">Vse</option>
      {% for c in categories %}
        <option value="{{ c.id }}"
          {% if request.args.get('category') == c.id|string %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>
  </th>

  <th>
    <select name="subcategory" class="form-control form-control-sm">
      <option value="">Vse</option>
      {% for s in subcategories %}
        <option value="{{ s.id }}"
          {% if request.args.get('subcategory') == s.id|string %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </th>

  <th>
    <button class="btn btn-sm btn-primary w-100">Filter</button>
  </th>
</tr>
    </thead>
    <tbody>
    {% for r in records %}
        <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.competitor_name }}</td>
            <td>{{ r.club or '-' }}</td>
            <td class="col-result"><strong>{{ r.result }}</strong></td>
            <td>{{ r.date.strftime('%d.%m.%Y') }}</td>
            <td>{{ r.location or '-' }}</td>
            <td>{{ r.competition_type.name }}</td>
            <!-- PODTIP -->
            <td class="subtype-name">
              {{ r.competition_subtype.name if r.competition_subtype else '-' }}
            </td>

            <!-- PUŠČICE -->
            <td class="subtype-arrows">
              {{ r.competition_subtype.arrows if r.competition_subtype and r.competition_subtype.arrows else '-' }}
            </td>
            <td>{{ r.style.name }}</td>
            <td>{{ r.gender.name }}</td>
            <td>{{ r.category.name }}</td>
            <td>{{ r.subcategory.name if r.subcategory else '-' }}</td>
            <td>
                <button class="btn btn-sm btn-primary"
                    data-toggle="modal"
                    data-target="#editRecordModal"
                    data-id="{{ r.id }}"
                    data-competitor="{{ r.competitor_name }}"
                    data-club="{{ r.club }}"
                    data-result="{{ r.result }}"
                    data-location="{{ r.location }}"
                    data-date="{{ r.date.strftime('%d.%m.%Y') }}"
                    data-competition_type="{{ r.competition_type_id }}"
                    data-competition_subtype="{{ r.competition_subtype_id }}"
                    data-style="{{ r.style_id }}"
                    data-gender="{{ r.gender_id }}"
                    data-category="{{ r.category_id }}"
                    data-subcategory="{{ r.subcategory_id if r.subcategory else '' }}">
                Edit
                </button>

                <button class="btn btn-sm btn-danger deleteRecordBtn"
                      data-toggle="modal"
                      data-target="#deleteRecordModal"
                      data-id="{{ r.id }}"
                      data-name="{{ r.competitor_name }}"
                      data-result="{{ r.result }}"
                      data-location="{{ r.location }}"
                      data-date="{{ r.date.strftime('%d.%m.%Y') }}">
                Delete
              </button>

            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</form>
</div>

{% if records|length == 0 %}
<p class="text-muted">Ni vnešenih rekordov.</p>
{% endif %}

<div class="modal fade" id="newRecordModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="post" action="{{ url_for('record_new') }}">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Nov rekord</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">

          <div class="form-row">
            <div class="form-group col-md-6" id="singleCompetitorGroup">
              <label>Ime in priimek</label>
              <input
                name="competitor_name"
                id="singleCompetitor"
                class="form-control">
            </div>

            <div class="form-group col-md-12" id="teamGroup" style="display:none">
              <fieldset class="border p-3 rounded">
                <legend class="w-auto px-2">Ekipa</legend>

                <div class="form-row">
                  <div class="form-group col-md-4">
                    <label>Tekmovalec 1</label>
                    <input name="team_1" class="form-control">
                  </div>
                  <div class="form-group col-md-4">
                    <label>Tekmovalec 2</label>
                    <input name="team_2" class="form-control">
                  </div>
                  <div class="form-group col-md-4">
                    <label>Tekmovalec 3</label>
                    <input name="team_3" class="form-control">
                  </div>
                </div>
              </fieldset>
            </div>

            <div class="form-group col-md-6">
              <label>Klub</label>
              <input name="club" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Rezultat</label>
              <input name="result" class="form-control" required>
            </div>

            <div class="form-group col-md-4">
              <label>Datum</label>
              <input type="date" name="date" class="form-control" required>
            </div>

            <div class="form-group col-md-4">
              <label>Kraj</label>
              <input name="location" class="form-control">
            </div>
          </div>

          <hr>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Disciplina</label>
              <select name="competition_type_id" id="competitionTypeSelect" class="form-control" required>
                {% for c in competition_types %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Podtip</label>
              <select name="competition_subtype_id" id="competitionSubTypeSelect" class="form-control">
                {% for s in competition_subtypes %}
                  <option value="{{ s.id }}" data-type="{{ s.competition_type_id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Stil</label>
              <select name="style_id" class="form-control" required>
                {% for s in styles %}
                  <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Spol</label>
              <select name="gender_id" id="genderSelect" class="form-control" required>
                {% for g in genders %}
                  <option value="{{ g.id }}">{{ g.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Kategorija</label>
              <select name="category_id" id="categorySelect" class="form-control" required>
                {% for c in categories %}
                  <option value="{{ c.id }}" data-gender="{{ c.gender_id }}">
                    {{ c.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Podkategorija</label>
              <select name="subcategory_id" id="subcategorySelect" class="form-control">
                {% for s in subcategories %}
                  <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Shrani</button>
          <button class="btn btn-secondary" data-dismiss="modal">Prekliči</button>
        </div>

      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="editRecordModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="post" id="editRecordForm">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Uredi rekord</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id" id="edit_record_id">

          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Ime in priimek</label>
              <input type="text" name="competitor_name" id="edit_competitor_name" class="form-control" required>
            </div>
            <div class="form-group col-md-6">
              <label>Klub</label>
              <input type="text" name="club" id="edit_club" class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Rezultat</label>
              <input type="text" name="result" id="edit_result" class="form-control" required>
            </div>
            <div class="form-group col-md-4">
              <label>Datum</label>
              <input type="date" name="date" id="edit_date" class="form-control" required>
            </div>
            <div class="form-group col-md-4">
              <label>Kraj</label>
              <input type="text" name="location" id="edit_location" class="form-control">
            </div>
          </div>

          <hr>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Disciplina</label>
              <select name="competition_type_id" id="edit_competition_type_id" class="form-control" required>
                {% for c in competition_types %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Podtip</label>
              <select name="competition_subtype_id" id="edit_competition_subtype_id" class="form-control">
                <option value="">---</option>
                {% for s in competition_subtypes %}
                  <option value="{{ s.id }}">{{ s.name }}{% if s.arrows %} ({{ s.arrows }}){% endif %}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Stil</label>
              <select name="style_id" id="edit_style_id" class="form-control" required>
                {% for s in styles %}
                  <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Spol</label>
              <select name="gender_id" id="edit_gender_id" class="form-control" required>
                {% for g in genders %}
                  <option value="{{ g.id }}">{{ g.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Kategorija</label>
              <select name="category_id" id="edit_category_id" class="form-control" required>
                {% for c in categories %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Podkategorija</label>
              <select name="subcategory_id" id="edit_subcategory_id" class="form-control" disabled>
                {% for s in subcategories %}
                  <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
              </select>
              <!-- Hidden input za POST -->
              <input type="hidden" name="subcategory_id" value="1">
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Shrani</button>
          <button class="btn btn-secondary" data-dismiss="modal">Prekliči</button>
        </div>

      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="deleteRecordModal" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <form method="post" id="deleteRecordForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Brisanje rekorda</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <p>Ali ste prepričani, da želite izbrisati rekord:</p>
          <strong id="deleteRecordName"></strong>

          <ul class="list-unstyled mt-2 mb-0">
            <li><strong>Rezultat:</strong> <span id="deleteRecordResult"></span></li>
            <li><strong>Kraj:</strong> <span id="deleteRecordLocation"></span></li>
            <li><strong>Datum:</strong> <span id="deleteRecordDate"></span></li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Izbriši</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Prekliči</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>

  const DEFAULT_GENDER_ID = '1'; // Moški
  const DEFAULT_COMPETITION_TYPE_ID = '1'; // Tarčno
  const POSAMEZNO_ID = '1'; // Posamezno

document.addEventListener('DOMContentLoaded', function () {

    // poišči vse edit gumbe
    const editButtons = document.querySelectorAll('button[data-target="#editRecordModal"]');
    editButtons.forEach(btn => {
      const subtypeId = btn.dataset.subcategory; // dobimo ID iz data-atributa
      if (subtypeId !== POSAMEZNO_ID) {
        btn.disabled = true;
        btn.title = "Editiranje mogoče samo za Posamezno"; // opcijsko tooltip
      }
    });
  });

// --- New ---

  $('#newRecordModal').on('show.bs.modal', function () {

    // Podkategorija = Posamezno
    const subSelect = document.getElementById('subcategorySelect');
    for (let option of subSelect.options) {
      if (option.text.trim() === 'Posamezno') {
        subSelect.value = option.value;
        break;
      }
    }

    // Posamezno UI
    document.getElementById('singleCompetitorGroup').style.display = 'block';
    document.getElementById('teamGroup').style.display = 'none';

    // Spol = Moški (hard set)
    const genderSelect = document.getElementById('genderSelect');
    genderSelect.value = DEFAULT_GENDER_ID;

    // takoj filtriraj kategorije
    filterCategoriesByGender(DEFAULT_GENDER_ID);

    const typeSelect = document.getElementById('competitionTypeSelect');

    // nastavi default = Tarčno
    typeSelect.value = DEFAULT_COMPETITION_TYPE_ID;

    // filtriraj podtip glede na ta default
    filterSubtypesByType(typeSelect.value);

  });

  // reakcija na ročno spremembo
  $('#genderSelect').on('change', function () {
    filterCategoriesByGender(this.value);
  });

  function filterCategoriesByGender(genderId) {
    const categorySelect = document.getElementById('categorySelect');
    let firstVisible = null;

    for (let option of categorySelect.options) {
      if (option.dataset.gender === genderId) {
        option.hidden = false;
        if (!firstVisible) firstVisible = option;
      } else {
        option.hidden = true;
      }
    }

    // nastavi prvo veljavno kategorijo
    if (firstVisible) {
      categorySelect.value = firstVisible.value;
    }
  }

  function filterSubtypesByType(typeId) {
  const subtypeSelect = document.getElementById('competitionSubTypeSelect');
  let firstVisible = null;

  for (let option of subtypeSelect.options) {
    if (option.dataset.type === typeId) {
      option.hidden = false;
      if (!firstVisible) firstVisible = option;
    } else {
      option.hidden = true;
    }
  }

  // nastavi prvo veljavno podtip opcijo
  if (firstVisible) {
    subtypeSelect.value = firstVisible.value;
  } else {
    // če ni nič, reset
    subtypeSelect.value = '';
  }
}

$('#competitionTypeSelect').on('change', function () {
  filterSubtypesByType(this.value);
});

$('#newRecordModal form').on('submit', function(e){
    // če je ekipa skrita, odstranimo required iz vseh team inputov
    if (document.getElementById('teamGroup').style.display === 'none') {
        const teamInputs = document.querySelectorAll('#teamGroup input');
        teamInputs.forEach(input => input.removeAttribute('required'));
    }
});


// --- Edit ---

$('#editRecordModal').on('show.bs.modal', function(event){
    var button = $(event.relatedTarget); // gumb
    console.log("Button data:", button.data()); // preveri, kaj prenaša
    var modal = $(this);

    modal.find('#edit_record_id').val(button.data('id'));
    modal.find('#edit_competitor_name').val(button.data('competitor'));
    modal.find('#edit_club').val(button.data('club'));
    modal.find('#edit_result').val(button.data('result'));
    modal.find('#edit_location').val(button.data('location'));
    modal.find('#edit_date').val(button.data('date'));
    modal.find('#edit_competition_type_id').val(button.data('competition_type'));
    modal.find('#edit_competition_subtype_id').val(button.data('competition_subtype'));
    modal.find('#edit_style_id').val(button.data('style'));
    modal.find('#edit_gender_id').val(button.data('gender'));
    modal.find('#edit_category_id').val(button.data('category'));
    modal.find('#edit_subcategory_id').val(button.data('subcategory'));

    modal.find('form').attr('action', '/rekordi/edit/' + button.data('id'));
});

  const subcategorySelect = document.getElementById("subcategorySelect");

  const singleGroup = document.getElementById("singleCompetitorGroup");
  const singleInput = document.getElementById("singleCompetitor");

  const teamGroup = document.getElementById("teamGroup");
  const teamInputs = teamGroup.querySelectorAll("input");

  function isTeamCategory() {
    const text =
      subcategorySelect.options[subcategorySelect.selectedIndex].text.trim();

    return text === "Klubska ekipa" || text === "Reprezentančna ekipa";
  }

  function toggleCompetitors() {
    const team = isTeamCategory();

    // Posameznik
    singleGroup.style.display = team ? "none" : "block";
    singleInput.toggleAttribute("required", !team);

    // Ekipa
    teamGroup.style.display = team ? "block" : "none";
    teamInputs.forEach(i => i.toggleAttribute("required", team));

    if (team) singleInput.value = "";
    else teamInputs.forEach(i => i.value = "");
  }

  subcategorySelect.addEventListener("change", toggleCompetitors);
  toggleCompetitors(); // ob odprtju

  $('#editRecordForm').on('submit', function() {
    $(this).find('input[name="subcategory_id"]').val('1'); // ID Posamezno
});


// --- Delete Record

$('#deleteRecordModal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget); // gumb, ki je sprožil modal
    const id = button.data('id');
    const name = button.data('name');
    const result = button.data('result');
    const location = button.data('location');
    const date = button.data('date');

    // nastavimo vse elemente v modal
    $('#deleteRecordName').text(name);
    $('#deleteRecordResult').text(result);
    $('#deleteRecordLocation').text(location);
    $('#deleteRecordDate').text(date);

    // nastavitev forme za submit
    $('#deleteRecordForm').attr('action', '/rekordi/delete/' + id);
});


</script>

{% endblock %}