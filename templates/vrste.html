{% extends 'base.html' %}

{% block content %}
    <h1>Vrste Tekmovanj</h1>
    <p>Izberite kategorijo za prikaz rekordov:</p>

    <!-- Drevesna struktura - levo -->
    <div class="tree">
        <ul>
            {% for competition_type in competition_types %}
                <li>
                    <span class="caret" onclick="showRecordTypesForCompetitionType({{ competition_type.id }})">{{ competition_type.name }}</span>
                    <span id="competition-type-{{ competition_type.id }}-count"></span>
                    <ul class="nested">
                        {% for style in competition_type.styles %}
                            <li>
                                <span class="caret" onclick="showRecordTypesForStyle({{ style.id }})">{{ style.name }}</span>
                                <span id="style-{{ style.id }}-count"></span>
                                <ul class="nested">
                                    {% for gender in style.genders %}
                                        <li>
                                            <span class="caret" onclick="showRecordTypesForGender({{ gender.id }})">{{ gender.name }}</span>
                                            <span id="gender-{{ gender.id }}-count"></span>
                                            <ul class="nested">
                                                {% for category in gender.categories %}
                                                    <li>
                                                        <span class="caret" onclick="showRecordTypesForCategory({{ category.id }})">{{ category.name }}</span>
                                                        <span id="category-{{ category.id }}-count"></span>
                                                        <ul class="nested">
                                                            {% for subcategory in category.subcategories %}
                                                                <li>
                                                                    <span>{{ subcategory.name }}</span>
                                                                    {% if subcategory.record_types|length > 0 %}
                                                                        <button class="btn btn-info" onclick="showRecordTypes({{ subcategory.id }})">
                                                                            Prikaži Record Types
                                                                        </button>
                                                                    {% endif %}
                                                                </li>
                                                            {% endfor %}
                                                        </ul>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Desni del - Prikaz tabele -->
    <div class="table-container" id="record-types-container">
        <h3>Record Types</h3>
        <table id="record-types-table" class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ime</th>
                    <th>Število puščic</th>
                    <th>Velikost lice</th>
                    <th>Aktiven</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5">Izberite subkategorijo za prikaz podatkov.</td></tr>
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Funkcija za pridobivanje števila RecordTypes za CompetitionType
        function showRecordTypesForCompetitionType(competitionTypeId) {
            $.getJSON('/get_record_types_for_competition_type/' + competitionTypeId, function(data) {
                $('#competition-type-' + competitionTypeId + '-count').text(' - Record Types: ' + data.record_types_count);
            });
        }

        // Funkcija za pridobivanje števila RecordTypes za Style
        function showRecordTypesForStyle(styleId) {
            $.getJSON('/get_record_types_for_style/' + styleId, function(data) {
                $('#style-' + styleId + '-count').text(' - Record Types: ' + data.record_types_count);
            });
        }

        // Funkcija za pridobivanje števila RecordTypes za Gender
        function showRecordTypesForGender(genderId) {
            $.getJSON('/get_record_types_for_gender/' + genderId, function(data) {
                $('#gender-' + genderId + '-count').text(' - Record Types: ' + data.record_types_count);
            });
        }

        // Funkcija za pridobivanje števila RecordTypes za Category
        function showRecordTypesForCategory(categoryId) {
            $.getJSON('/get_record_types_for_category/' + categoryId, function(data) {
                $('#category-' + categoryId + '-count').text(' - Record Types: ' + data.record_types_count);
            });
        }

        // Funkcija za prikazovanje RecordTypes po klikih
        function showRecordTypes(subcategoryId) {
            $('#record-types-container').show();
            $.getJSON('/get_record_types/' + subcategoryId, function(data) {
                let tableContent = '';
                if(data.length > 0) {
                    data.forEach(function(r) {
                        tableContent += `<tr>
                            <td>${r.id}</td>
                            <td>${r.name}</td>
                            <td>${r.arrow_count}</td>
                            <td>${r.face}</td>
                            <td>${r.is_active ? 'Da' : 'Ne'}</td>
                        </tr>`;
                    });
                } else {
                    tableContent = '<tr><td colspan="5">Ni podatkov</td></tr>';
                }
                $('#record-types-table tbody').html(tableContent);
            });
        }

        // Funkcija za navigacijo po drevesni strukturi
        var toggler = document.getElementsByClassName("caret");
        var i;
        for (i = 0; i < toggler.length; i++) {
            toggler[i].addEventListener("click", function() {
                this.parentElement.querySelector(".nested").classList.toggle("active");
                this.classList.toggle("caret-down");
            });
        }
    </script>

    <style>
        /* Drevesna struktura - levo */
        .tree {
            width: 45%;
            float: left; /* Plava na levo */
            padding: 20px;
        }

        .tree ul {
            list-style-type: none;
            padding-left: 20px;
        }

        .tree li {
            cursor: pointer;
            user-select: none;
        }

        .caret {
            user-select: none;
            cursor: pointer;
        }

        .caret-down::before {
            content: "▼ ";
        }

        .caret::before {
            content: "▶ ";
        }

        .nested {
            display: none;
        }

        .nested.active {
            display: block;
        }

        /* Tabela na desni */
        .table-container {
            width: 45%;
            padding: 20px;
            display: none; /* Začetno skrito */
            float: right; /* Plava na desno */
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-container th, .table-container td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .table-container th {
            background-color: #f4f4f4;
        }

        /* Omogoči pomikanje tabele, če je preveč podatkov */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Zbriši vse plavanje po koncu vsebine */
        .clear {
            clear: both;
        }
    </style>
{% endblock %}
